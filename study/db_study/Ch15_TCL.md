# 공부한 내용


## 1. 트랜잭션 개요

트랜잭션은 데이터베이스의 논리적 연산단위이다. 그리고 분할할 수 없는 최소의 단위이기 때문에 전부 적용하거나 전부 취소하는 것만 가능하다.

굳이 이렇게 동작하는 이유는 모두 **데이터의 무결성**을 지키기 위해서이다.

- 커밋과 롤백
    - 커밋: 연산이 잘 진행되고 실제로 DB에 반영하는 작업
    - 롤백: 연산을 진행하다 다시 맨 처음으로 복구시키는 작업
    - LOCK: 트랜잭션 진행 중에 다른 사람이 해당 데이터를 변경하는 것을 막는 것

![](https://www.checkmal.com/.file/.CKEditor/20211404919_editor_image.png)

어떻게 보면 이 윈도우 설정창과 비슷한 것 같다.

트랜잭션 내에서 작업을 진행해서 확인하는 것은 “적용”, 그것을 반영하는 것은 “확인”, 그리고 원 상태로 돌리는 것은 “취소”과 같다.

## 2. COMMIT

위에서 설명한 것처럼 CRUD 작업을 진행하고 최종적으로 반영할 때 커밋 명령어를 사용한다.

### 커밋의 과정(데이터 수정)

트랜잭션 시작 → LOCK 획득 → 데이터 수정 → 변경사항 검토 → 커밋 → LOCK 해제 → 트랜잭션  종료

### 커밋의 특징

트랜잭션 내에서 진행한 작업은 “메모리 영역”에서 진행된 것이고, 아직 물리적 저장소에 반영이 되지 않은 부분이기 때문에 쉽게 원상태로 복구가 가능하다.

또한 트랜잭션 내에서 현재 사용자는 수행한 명령의 결과를 확인 가능하지만, 타 사용자는 확인 불가능하다.

### 암시적 트랜잭션 / 명시적 트랜잭션

트랜잭션은 그 시작과 끝을 자동으로 처리하느냐, 수동으로 처리하느냐에 따라 종류가 갈린다.

- AUTO COMMIT → 트랜잭션의 시작과 끝 모두 DBMS가 처리한다.
- 암시적 트랜잭션 → 트랜잭션의 시작은 DBMS가 처리하고 종료는 사용자가 알아서 처리한다.
- 명시적 트랜잭션 → 트랜잭션의 시작과 끝 모두 사용자가 처리한다.

## 3. ROLLBACK

트랜잭션 내에서 명령을 처리하다가 원상태로 되돌리는 작업이다. 당연하지만 원상태로 돌려지면 락이 풀리면서 트랜잭션이 종료된다.

롤백을 사용하고 싶을 때 주의해야 할 점은, AUTO COMMIT 설정이 되어있는 경우에는 자동으로 트랜잭션이 종료되기 때문에 사용자가 명시적으로 트랜잭션을 선언해야한다는 것이다.

## 4. SAVEPOINT

세이브 포인트 기능은 롤백을 진행할 떄 맨 처음으로 돌리지 않고, 특정 시점까지만 되돌아가고 싶을 때 사용하는 기능이다.

다음과 같이 세이브 포인트를 지정하면, 롤백 명령어 뒤에 옵션을 붙임으로써 그 곳으로 돌아갈 수 있다.

```sql
SAVEPOINT SVPT1;
ROLLBACK TO SVPT1;
```

주의할 점은, 세이브 포인트 1, 2, 3이 있다면 제일 앞 쪽인 1 포인트로 갔을 때 뒤에 있던 2, 3포인트들이 **사라지게 된다.**

## 5. 그 밖의 주의할 점

- DDL 문장 실행 시에는 실행시점 전후로 **반드시  커밋이 진행**된다. 따라서 DML + DDL 조합으로 명령을 처리하다 보면 원치 않는 커밋이 중간에 생길 수 있다.
- 어플리케이션이 비정상적으로 종료되면, 진행되던 트랜잭션은 자동으로 롤백된다.

# 어려웠던 내용


# 궁금한 내용 / 부족한 내용


## Q1. LOCK의 종류에는 무엇이 있을까?

LOCK의 종류에는 기본적으로 공유 LOCK과 배타 LOCK이 있다. 읽기 작업에서는 공유 락이 걸리고, 그 외의 작업에서는 배타 락이 걸린다.

- **공유 락(Shared Lock)**: 데이터를 읽기만 하는 경우, 다른 사용자도 동시에 데이터를 읽을 수 있도록 공유 락이 걸립니다. 하지만, 이 상태에서는 데이터의 수정이 불가능합니다.
- **배타 락(Exclusive Lock)**: 데이터를 수정하기 위해서는 배타 락이 필요합니다. 배타 락이 걸린 데이터는 해당 트랜잭션만 접근할 수 있으며, 다른 트랜잭션은 해당 데이터를 읽거나 쓸 수 없습니다.

## Q2. 트랜잭션 진행 중에 어플리케이션이 비정상 종료되면 어떤 방법으로 정보 불일치를 해결할까?

문득 트랜잭션 진행 중에 어플리케이션이 비정상 종료되면, 트랜잭션은 원상태로 롤백이 되겠지만 어플리케이션은 처리가 성공한 것으로 인식하는 정보 불일치가 발생하지 않을까? 라는 생각이 들었다.

당연하게도 요즘 나오는 DB 접근 기술들은 이런 문제에 대한 대비가 되어있을텐데, 어떤 방식으로 이러한 정보 불일치에 대비하는지에 대해 알아보았다.

### 트랜잭션 로깅

평소에 트랜잭션 로그로 남기다가, 필요할 때 확인하는 방법이다.

로그 안에는 트랜잭션 ID, 시작 일시, 작업 내용 등이 들어가있는데, 만약 어플리케이션이 비정상적으로 종료되었다면 마지막으로 찍힌 로그를 확인해서 트랜잭션 처리 상태를 대조해볼 수 있다.

### 자동 복구 시스템

위와 같은 방법을 통해, 시스템 재시작 시나 필요한 순간에 자동으로 불일치가 있는지 조사하여 복구시키는 시스템 또한 존재한다.

### 사용자 개입

상당히 슬픈 상황이지만, 시스템의 도움을 받아 복구가 안 되는 정도의 큰 문제가 발생했다면 사용자가 직접 개입해서 데이터를 복구해야 한다.

로그들을 직접 뒤져보면서 어디가 잘못됐는지 확인하고, 터미널 띄워서 직접 명령어 치면서 복구하고, 다시 잘 되는지 테스트 해보고… 이런 과정들을 겪게 될 것이다.