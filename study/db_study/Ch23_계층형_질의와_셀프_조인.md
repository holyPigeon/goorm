# 공부한 내용

## 1. 계층형 질의

가끔 테이블에 계층형 데이터가 존재하는 경우가 있는데, 이 경우에는 “계층형 질의”를 사용하여 조회해야 한다.

예를 들자면 다음과 같다.

!https://dataonair.or.kr/publishing/img/knowledge/SQL_206.jpg

### 오라클에서의 계층형 질의

오라클에서는 START WITH, CONNECT BY 절을 통해 계층형 질의를 사용할 수 있다.

예시 코드는 다음과 같다.

```sql
SELECT emp_id, name, manager_id
FROM employees
START WITH emp_id = 1
CONNECT BY PRIOR emp_id = manager_id
ORDER SIBLINGS BY name;
```

- START WITH emp_id = 1
    - emp_id가 1인 직원부터 조회 시작

- CONNECT BY PRIOR emp_id = manager_id
    - 현재 조회중인 직원의 emp_id 가 manger_id 와 같은 경우, 즉 현재 직원이 다른 직원의 상사인 경우 계층구조를 재귀적으로 탐색한다.

- 간혹 CYCLE이 형성되는 경우가 있는데, CYCLE이란 전개 중에 이미 등장한 데이터가 다시 등장하는 것을 뜻한다.
    - ex. A가 B의 상사인데, 다시 B가 A의 상사인 경우 관계가 돌고 돈다.
    - 이런 경우 CONNECT BY 절 뒤에 NO CYCLE 옵션을 추가하면 무한 재귀를 방지할 수 있다.

### 가상 칼럼

가상 칼럼은 오라클에서 계층형 쿼리를 수행할 때 자동으로 생성되는 칼럼이다.

계층형 질의를 사용하면 데이터를 트리의 형태로 탐색하게 된다.

가상 칼럼의 종류는 다음과 같다.

![](https://dataonair.or.kr/publishing/img/knowledge/SQL_208.jpg)

계층형 질의를 사용하면 데이터를 트리의 형태로 탐색하게 되는데, LEVEL은 거기서 트리의 깊이를 나타내고, CONNECT_BY_ISLEAF는 리프 데이터인지에 대해, CONNECT_BY_ISCYCLE은 사이클 상태인지에 대해 알려준다.

### 계층형 질의에서 사용되는 함수

또한 오라클에서는 계층형 질의 사용 시 사용자 편의성을 위해 다음과 같은 함수를 제공한다.

![](https://dataonair.or.kr/publishing/img/knowledge/SQL_211.jpg)

SQL Server 문법은 생략했다. 하나만 머릿속에 넣기도 벅찬데 둘 다 넣으면 아예 이해불가일 것 같아서…

## 2. 셀프 조인

셀프 조인이란 동일 테이블 사이에서 조인하는 것을 뜻한다. 말 그대로 그냥 똑같은 테이블을 조건에 따라 합치는 것이다.

당연히 동일한 테이블을 그대로 쿼리에 넣으면 시스템이 구분을 하지 못하기 때문에 별칭을 사용해서 미리 둘을 구분해야 한다.

위에 있는 “사원 ↔ 관리자” 예시와 같이 테이블 상에는 같은 칼럼으로 속해있지만, 논리적으로는 역할이 차이가 나는 상황일 때 셀프 조인을 사용할 수 있다.

![](https://dataonair.or.kr/publishing/img/knowledge/SQL_213.jpg)

